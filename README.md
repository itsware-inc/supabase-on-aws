# Itsware Hosted Supabase on AWS - CloudFormation/CDK Template

This repo includes a modified template of a starting Supabase stack on AWS via CloudFormation/CDK. This template uses the following managed services:
- Route53 
- AWS ECS
- AWS Aurora
- AWS ECR
- AWS ALB
- AWS Amplify
- Cloudfront
- AWS Certificate Manager
- AWS WAF and Shield
- AWS Backup
- AWS Lambda
- AWS S3

## Architecture

![architecture-diagram](./docs/images/itsware-architecture-diagram.png)

### Specifications and Limitations (taken from original [README](./README_Community_Supabase.md)

- APIs
  - All containers run on ECS Fargate (Graviton2).
  - All components are configured with AutoScaling.
  - GraphQL is not supported, because [pg_graphql](https://github.com/supabase/pg_graphql) is not supported with Amazon RDS/Aurora.
- Service Discovery
  - Each component is discovered as `***.supabase.internal`.
- Database (PostgreSQL)
  - [Amazon Aurora Serverless v2](https://aws.amazon.com/rds/aurora/serverless/) is used.
  - Todo: Add automatically password rotation.
- Supabase Studio
  - It is deployed on [Amplify Hosting](https://aws.amazon.com/amplify/hosting/).
  - Todo: Add option to deploy the studio in different regions.
  - ⚠️ Warning: Supabase Studio is **open to web** and can be accessed by malicious actors. We **strongly** suggest you active ['Access control'](https://docs.aws.amazon.com/amplify/latest/userguide/access-control.html) globaly and setup a strong password and username.


### Itsware Specific Modifications to Base Supabase CDK deploy

- Route53
  - Alias added for studio.itsware.com (Supabase Studio Dashboard) [Manually done through the dashboard].
  - Alias added for supabase.itsware.com (Supabase Backend Services) [Manually done through the dashboard].
  - Healthchecks added for both endpoints. **NOTE** Due to auth protection being in place for each endpoint, the health checks use an inverted check , so that a 401 from each is proof of liveness [Manually done through the dashboard].
- Cloudfront
  - Alternate domain of supabase.itsware.com added to allow for Kong reverse proxy to accept requests from clients that use this endpoint when making Supabase REST calls [Manually done through the dashboard].
- AWS Amplify
  - HTTPS domain of studio.itsware.com added to allow developers to access the Supabase dashboard using a vanity domain instead of the autogenerated one [Manually done through the dashboard].
- AWS Aurora
  - Created a new VPC and subnet group for us-west for the replicas to be created
  - Aurora Postgres does not support cross-region read replicas.
  - Regional Cluster [Deployed via CDK] was converted into a Global Cluster [Manually done through the dashboard]
  - The read replica setup requires the replica to be instanced in more than one region , so that is why there are 2 instances in us-west instead of 1
- AWS Backup
  - This was turned on and configured for all Supabase resources [Manually done through the dashboard]

## Deploy via CDK

- Prerequisites
  - Install and configure [CDK](https://docs.aws.amazon.com/cdk/v2/guide/getting_started.html)
  - Configure [AWS SSO tokens](https://docs.aws.amazon.com/cli/latest/userguide/sso-configure-profile-token.html)

```bash
git clone https://github.com/itsware-inc/supabase-on-aws.git

cd supabase-on-aws

yarn install

cdk deploy Supabase
```
